/*
    Meet-the-Fans 1.0.1
    https://github.com/evoluteur/meet-the-fans
    (c) 2021 Olivier Giulieri
*/
let reposH={"*":gitUser},totals={nbStars:0,nbForks:0},licensesH={};const repos=gitUser.repos;repos.forEach(e=>{totals.nbStars+=e.nbStars,totals.nbForks+=e.nbForks,reposH[e.name]=e;const t=licensesH[e.licenseName];t?t.repos.push(e.name):licensesH[e.licenseName]={id:e.licenseName,repos:[e.name]}}),gitUser.nbStars=totals.nbStars,gitUser.nbForks=totals.nbForks,gitUser.name="*",fans[gitUser.login]&&delete fans[gitUser.login];const size=e=>5+2*(e.starred.length+e.forked.length),userColorGroup=e=>e.forked.length?e.starred.length?"both":"fork":e.follower?"follower":"star",getData=()=>{let o=[],r=[];for(var t in repos.forEach((e,t)=>{e.group=t+2,o.push({id:e.name,oType:"repo",radius:Math.min(10+e.nbStars/10,100),group:e.group,isRepo:!0}),r.push({source:"*",target:e.name,value:4})}),repos.push({name:"*",description:"Evoluteur"}),o.push({id:"*",radius:20,group:0,isRepo:!0}),fans){const i=fans[t];o.push({id:t,radius:size(i),oType:"user",group:userColorGroup(i)}),i.starred.forEach(e=>r.push({source:t,target:e,value:1})),i.forked.forEach(e=>{i.starred.includes(e)||r.push({source:t,target:e,value:1})})}return{nodes:o,links:r}},height=config.height||2e3,width=config.width||2500,userColors=config.userColors,colorFaded=config.colorFaded||"#eeeeee",circleBorder=config.circleBorder||"white",lineColor=config.lineColor||"white",scaleProject=d3.scaleOrdinal(d3.schemeCategory10),color=e=>e.isRepo?scaleProject(e.group):userColors[e.group],linksDistance=config.linksDistance||50,linksCharge=config.linksDistance||-30,drag=t=>{return d3.drag().on("start",e=>{e.active||t.alphaTarget(.3).restart(),e.subject.fx=e.subject.x,e.subject.fy=e.subject.y}).on("drag",e=>{e.subject.fx=e.x,e.subject.fy=e.y}).on("end",e=>{e.active||t.alphaTarget(0),e.subject.fx=null,e.subject.fy=null})};let selectedRepo=null;const graph=e=>{var t=e.links,e=e.nodes,r=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);const o=d3.forceSimulation(e).force("link",d3.forceLink(t).distance(50).id(e=>e.id)).force("charge",d3.forceManyBody().strength(-30)).force("center",d3.forceCenter(width/2,height/2)).force("collision",d3.forceCollide().radius(e=>e.radius)),i=d3.create("svg").attr("viewBox",[0,0,width,height]).on("click",hideDetails),s=i.append("g");i.call(d3.zoom().extent([[0,0],[width,height]]).scaleExtent([1,8]).on("zoom",({transform:e})=>{s.attr("transform",e)}));const l=s.attr("stroke",lineColor).selectAll("line").data(t).join("line").attr("stroke-width",1),a=s.attr("stroke","#fff").attr("stroke-width",1.5).selectAll("circle").data(e).join("circle").attr("id",e=>e.id).attr("r",e=>e.radius).attr("stroke",circleBorder).attr("fill",color).attr("class",e=>e.oType).call(drag(o)).on("click",showDetails).on("mouseover",(e,t)=>{r.transition().duration(200).delay(400).style("opacity",.9);const o=r.html(t.isRepo?repoItem(reposH[t.id]):userTooltip(t));e.pageX+100>window.innerWidth?o.style("left",window.innerWidth-100+"px"):o.style("right",null).style("left",e.pageX+20+"px"),o.style("bottom",null).style("top",e.pageY+10+"px")}).on("mouseout",(e,t)=>{r.transition().duration(200).style("opacity",0)});return o.on("tick",()=>{l.attr("x1",e=>e.source.x).attr("y1",e=>e.source.y).attr("x2",e=>e.target.x).attr("y2",e=>e.target.y),a.attr("cx",e=>e.x).attr("cy",e=>e.y)}),i.node()},hideDetails=e=>{d3.selectAll("circle").transition().duration(600).style("fill",color).style("stroke",circleBorder),d3.selectAll("line").transition().duration(600).style("stroke",lineColor),selectedRepo=null},showDetails=(e,o)=>{if(e.stopPropagation(),"rgb(238, 238, 238)"===e.target.style.fill&&"repo"!==o.oType)return null;if(!e.detail.skipModal){const i=document.getElementById("details");i.innerHTML=(o.isRepo&&"*"!==o.id?infoRepo:infoUser)(o.id),i.className=(o.x>width/2?"left":"right")+(o.isRepo?" w220":"")}let t,r=e=>o.id!==e.source.id&&o.id!==e.target.id;"repo"===o.oType?(selectedRepo=o.id,t=e=>{if("repo"===e.oType)return o.id!==e.id||""==e.id;{const t=fans[e.id];return!!t&&!(t.starred.includes(o.id)||t.forked.includes(o.id))}},d3.selectAll("circle").transition().duration(600).style("fill",e=>t(e)?colorFaded:color(e)).style("stroke",e=>t(e)?"#0288d1":circleBorder),d3.selectAll("line").transition().duration(600).style("stroke",e=>r(e)?colorFaded:lineColor).filter(e=>!r(e))):"user"===o.oType?(t=e=>{const t=fans[o.id];return!(t.starred.includes(e.id)||t.forked.includes(e.id))},r=e=>o.id===e.source.id,selectedRepo&&(d3.selectAll("circle.repo").transition().duration(600).style("fill",e=>t(e)?colorFaded:color(e)),r=e=>o.id===e.source.id,d3.selectAll("line").transition().duration(600).filter(r).style("stroke",lineColor))):hideDetails()},selectProject=e=>{var t=new CustomEvent("click",{detail:{skipModal:!0}});const o=document.getElementById(e);o&&o.dispatchEvent(t)},renderGraph=()=>{document.getElementById("graph").appendChild(graph(getData())),document.getElementById("details").onclick=e=>e.stopPropagation(),document.onclick=()=>document.getElementById("details").className=""},repoArr=e=>e.sort((e,t)=>e.localeCompare(t)).map(e=>"*"===e?gitUser:reposH[e]),textField=(e,t)=>t?`<div class="field"><label>${e}:</label> ${t}</div>`:"",urlField=(e,t)=>e[t]?`
  <div class="field ellipsis">
    <div class="icon link"></div> <a href="${e[t]}" target="${e.name}" rel="noopener">${e[t]}</a>
  </div>
`:"",iconTextField=(e,t)=>`<div class="icon ${e}"></div><span>${t}</span>`,icon=e=>'<div class="icon '+e+'"></div>',infoRepo=t=>{const e=repos.find(e=>e.name===t);var o="";return o+=`<h1><a href="${"https://github.com/"+gitUser.login+"/"+e.name}" target="${e.name}">
      <div class="repo-circle" style="background-color:${color({isRepo:!0,name:e.name||r.id,group:e.group})}"></div>
      ${e.name}
    </a></h1>`,o+=urlField(e,"homepageUrl"),o+=repoItemPop(e),o+=e.repos?repoList(repos):"",o+=e.description?`<div class="field">${e.description}</div>`:"",o+=textField("Updated",e.updatedAt),o+=textField("Created",e.createdAt),o+=e.licenseInfo?`<div class="field multi">${icon("license")}<a href="${e.licenseInfo.url}" target="${e.licenseInfo.key}" rel="noopener">${e.licenseInfo.name}</a></div>`:"",o+=e.languages&&e.languages.length?e.languages.map(e=>`<span><div style="background-color:${e.color}" class="ln-dot"></div>${e.name}</span>`).join(""):"",o+=htmlTopics(e.topics)},avatarPix=(e,t)=>`<div class="${t}"><img src="${e}"></div>`,userTooltip=e=>avatarPix(fans[e.id].avatarUrl,"avatar-small")+e.id+textField("Updated",e.updatedAt),infoUser=e=>{var t="*"===e?gitUser:fans[e];let o="";var r=t.login===gitUser.login,e="https://github.com/"+t.login;return o+=t.avatarUrl?'<div class="h190"><img src="'+t.avatarUrl+'"></div>':"",o+=`<h1><a href="${e}" target="${t.login}">${t.login}</a></h1>`,o+=t.fullName?`<div class="fullName">${t.fullName}</div>`:"",o+=urlField(t,"websiteUrl"),o+=urlField(t,"webURL"),o+=t.location?`<div class="field"><div class="icon location"></div><span> ${t.location}</span></div>`:"",o+=t.bio?`<div class="field">${t.bio}</div>`:"",o+='<div class="field multi">',o+=t.nbFollowers?`${icon("followers")}<a href="https://github.com/${t.login}?tab=followers" target="${"follow_"+t.name}" rel="noopener">${t.nbFollowers}</a>`:"",r?(o+=t.nbStars?iconTextField("star",t.nbStars):"",o+=t.nbForks?iconTextField("fork",t.nbForks):""):o+=t.nbRepos?`${icon("repos")}<a href="https://github.com/${t.login}?tab=repositories" target="${t.name}" rel="noopener">${t.nbRepos}</a>`:"",o+="</div>",r?o+=repoList(gitUser.repos,!0):(t.starred&&t.starred.length&&(o+='<div class="field"><label>Starred: '+t.starred.length+"</label>"+repoList(repoArr(t.starred),!1,!0)+"</div>"),t.forked&&t.forked.length&&(o+='<div class="field"><label>Forked: '+t.forked.length+"</label> "+repoList(repoArr(t.forked),!1,!0)+"</div>")),o},repoList=(e,t,o)=>'<div class="reposList">'+(o?"":'<span class="repoIco">'+icon("repos")+" "+e.length+"</span>")+e.map(e=>repoItem(e,t)).join("")+"</div>",repoItem=(e,t)=>{var o=e.login||"*"===e.name;if(o&&t)return"";var r=o?e.login:e.name,t=o?e.login:gitUser.login+"/"+e.name;return`
      <div>
        <a class="${o?"gituser":""}" href="javascript:selectProject('${e.name}')">
          <div class="repo-circle" style="background-color:${color({isRepo:!0,group:o?0:e.group})}"></div>
        </a>
        <a class="${o?"gituser":""}" href="https://github.com/${t}" target="${r}" rel="noopener">
          ${r}
        </a>
        ${o?`<div class="field multi">
          ${e.nbFollowers?icon("followers")+e.nbFollowers:""}
          ${e.nbStars?icon("star")+e.nbStars:""}
          ${e.nbForks?icon("fork")+e.nbForks:""}
        </div>`:repoItemPop(e)}
      </div>
    `};let topicList=[];const maxTopics=config.maxTopics||3,htmlTopic=e=>`<div><a href="https://github.com/topics/${e}" target="t_${e}">${e}</a></div>`,htmlTopics=e=>'<div id="my_topics" class="field topics">'+(topicList=e).slice(0,maxTopics).map(htmlTopic).join("")+(e.length>maxTopics?'<div class="morelink" onclick="moreTopics(event)">+ '+(e.length-maxTopics)+" more...</div>":""),moreTopics=e=>{e.stopPropagation(),document.getElementById("my_topics").innerHTML=topicList.map(htmlTopic).join("")},repoItemPop=e=>{var t=`https://github.com/${gitUser.login}/${e.name}/`,o=` target="${e.name}" rel="noopener"`;return`
<div class="field multi">
  ${e.nbStars?`${icon("star")}<a href="${t}stargazers" ${o}>${e.nbStars}</a>`:""}
  ${e.nbForks?`${icon("fork")}<a href="${t}network/members" ${o}>${e.nbForks}</a>`:""}
  ${e.version?`${icon("tag")}<a href="${t}releases/tag/${e.version}" class="bold" ${o}>${e.version}</a>`:""}
</div>
`};